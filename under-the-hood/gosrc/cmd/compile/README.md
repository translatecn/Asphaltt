<!---
// Copyright 2018 The Go Authors. All rights reserved.
// Use of this source code is governed by a BSD-style
// license that can be found in the LICENSE file.
-->

## Go 编译器简介

`cmd/compile` 包含构成Go编译器的主包。编译器可以在逻辑上分为四个阶段，我们将简要介绍包含其代码的包列表。

我们有时可能会使用“前端”和“后端”这两个术语编译器。粗略地说，这些转化为前两个和后两个阶段我们将在这里列出的阶段。第三个术语，“中端”，通常指的是在第二阶段发生的大部分工作。

注意 `go/*` 系列包，比如 `go/parser` 和 `go/types` ，与编译器无关。由于编译器最初是用C编写的，开发`go/*` 包以使用 Go代码编写工具，例如 `gofmt` 和 `vet`。

应该澄清的是，名称 “gc” 代表 “Go编译器”，并且具有与大写 “GC” 无关，它代表垃圾收集。

### 1. 解析

- `cmd/compile/internal/syntax`（词法分析器，解析器，语法树）

在编译的第一阶段，源代码被 token 化（词法分析），解析（语法分析），并为每个源构造语法树文件。每个语法树都是相应源文件的精确表示对应于源的各种元素的节点，如表达式，声明和陈述。语法树还包括位置信息用于错误报告和调试信息的创建。

### 2. 类型检查与 AST 转换

* `cmd/compile/internal/gc`（创建编译器AST，类型检查，AST转换）

gc 包中包含了一个从 C 语言开始编写的 AST 定义。它的所有代码都是根据它编写的，所以 gc 包必须做的第一件事就是将语法包的语法树转换为编译器的 AST 表示。这个额外的步骤可能会在将来重构。

然后对 AST 进行类型检查。第一步是名称解析和类型推断，它们确定哪个对象属于哪个标识符，以及每个表达式具有的类型。类型检查包括某些额外的检查，例如 “声明和未使用” 以及确定函数是否终止。

在 AST 上也进行了某些转换。一些节点基于类型信息被细化，例如从算术加法节点类型分割的字符串添加。其他一些例子是死代码消除，函数调用内联和转义分析。

### 3. 泛用型 SSA

* `cmd/compile/internal/gc` (转换为SSA)
* `cmd/compile/internal/ssa` (SSA 传递与规则)


在此阶段，AST将转换为静态单一分配（SSA）形式，这是一种具有特定属性的低级中间表示，可以更轻松地实现优化并最终从中生成机器代码。

在此转换期间，将应用函数内在函数。 这些是特殊功能，编译器已经教导它们根据具体情况用大量优化的代码替换。

在AST到SSA转换期间，某些节点也被降级为更简单的组件，因此编译器的其余部分可以使用它们。 例如，内置复制替换为内存移动，并且范围循环被重写为for循环。 其中一些目前发生在转换为SSA之前，由于历史原因，但长期计划是将所有这些都移到这里。

然后，应用一系列与机器无关的传递和规则。 这些不涉及任何单个计算机体系结构，因此可以在所有 `GOARCH` 变体上运行。

这些通用过程的一些示例包括消除死代码，删除不需要的零检查以及删除未使用的分支。通用重写规则主要涉及表达式，例如用常量值替换某些表达式，以及优化乘法和浮点运算。

### 4. 生成机器码

* `cmd/compile/internal/ssa` (底层SSA和架构特定的传递)
* `cmd/internal/obj` (生成机器码)

编译器的机器相关阶段以“底层”传递开始，该传递将通用值重写为其机器特定的变体。例如，在 amd64 存储器操作数上是可能的，因此可以组合许多加载存储操作。

请注意，较低的通道运行所有特定于机器的重写规则，因此它当前也应用了大量优化。

一旦SSA“降低”并且更加特定于目标体系结构，就会运行最终的代码优化过程。这包括另一个死代码消除传递，移动值更接近它们的使用，删除从未读取的局部变量，以及寄存器分配。

作为此步骤的一部分完成的其他重要工作包括堆栈框架布局，它将堆栈偏移分配给局部变量，以及指针活动分析，它计算每个 GC 安全点上的堆栈指针。

在SSA生成阶段结束时，Go 函数已转换为一系列 `obj.Prog` 指令。它们被传递给汇编程序（`cmd/internal/obj`），它将它们转换为机器代码并写出最终的目标文件。目标文件还将包含反射数据，导出数据和调试信息。

### 进一步阅读

若需进一步了解 SSA 包的工作原理，请阅读 [cmd/compile/internal/ssa/README.md](internal/ssa/README.md).